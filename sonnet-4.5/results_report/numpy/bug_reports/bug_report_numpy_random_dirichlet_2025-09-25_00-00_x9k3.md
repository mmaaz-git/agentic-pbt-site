# Bug Report: numpy.random.dirichlet NaN/Inf Values with Small Alpha

**Target**: `numpy.random.dirichlet`
**Severity**: High
**Bug Type**: Logic
**Date**: 2025-09-25

## Summary

The `numpy.random.dirichlet` function produces NaN and infinity values when given very small alpha parameters, violating the fundamental property that Dirichlet samples must be valid probability vectors summing to 1.

## Property-Based Test

```python
import numpy as np
from hypothesis import given, strategies as st, assume


@given(st.lists(st.floats(min_value=0.0, max_value=1.0, allow_nan=False, allow_infinity=False),
                min_size=2, max_size=10))
def test_dirichlet_sums_to_one(alpha):
    assume(all(a > 0 for a in alpha))
    samples = np.random.dirichlet(alpha, size=100)
    sums = samples.sum(axis=1)
    assert np.allclose(sums, 1.0)
```

**Failing input**: `alpha=[0.001953125, 0.00390625]`

## Reproducing the Bug

```python
import numpy as np

np.random.seed(42)
alpha = [0.001953125, 0.00390625]
samples = np.random.dirichlet(alpha, size=1000)

print(f"Samples with NaN: {np.isnan(samples).any(axis=1).sum()}")
print(f"Samples with inf: {np.isinf(samples).any(axis=1).sum()}")
print(f"Example invalid samples:\n{samples[np.isnan(samples).any(axis=1)][:3]}")
```

Output:
```
Samples with NaN: 18
Samples with inf: 2
Example invalid samples:
[[nan inf]
 [nan nan]
 [nan nan]]
```

## Why This Is A Bug

The Dirichlet distribution is defined to produce probability vectors where all components are non-negative and sum to exactly 1. The function accepts small positive alpha values without error, but then produces mathematically invalid results (NaN and infinity) instead of either:
1. Rejecting the input with a clear error message, or
2. Handling the numeric instability correctly to produce valid samples

This is a high-severity logic bug because it silently produces incorrect results that could corrupt downstream calculations in statistical or machine learning applications.

## Fix

The bug likely stems from numeric underflow when sampling from gamma distributions with very small shape parameters (the Dirichlet is generated by normalizing independent gamma samples). The fix should either:

1. Add input validation to reject alpha values below a numerically safe threshold (e.g., 1e-3), or
2. Use a numerically stable sampling algorithm for small alpha values (e.g., rejection sampling or alternative parameterizations)

A minimal fix would be to add validation:

```diff
--- a/numpy/random/mtrand.pyx
+++ b/numpy/random/mtrand.pyx
@@ -dirichlet function
+    if np.any(np.array(alpha) < 1e-3):
+        raise ValueError("alpha values must be >= 1e-3 for numerical stability")
     # existing implementation
```