# Bug Report: ServerErrorMiddleware Invalid HTML Entity

**Target**: `starlette.middleware.errors.ServerErrorMiddleware`
**Severity**: Low
**Bug Type**: Contract
**Date**: 2025-09-25

## Summary

ServerErrorMiddleware generates invalid HTML in debug mode by using `&nbsp` (without semicolon) instead of the correct HTML entity `&nbsp;` (with semicolon) when replacing spaces in code context lines.

## Property-Based Test

```python
from hypothesis import given, strategies as st
import html


@given(st.text(min_size=1, max_size=100).filter(lambda x: " " in x))
def test_nbsp_entity_correctness(line):
    result = html.escape(line).replace(" ", "&nbsp")

    assert "&nbsp;" in result or " " not in line, (
        "HTML entity for non-breaking space should be '&nbsp;' with semicolon"
    )
```

**Failing input**: Any text with spaces (e.g., `line="hello world"`)

## Reproducing the Bug

```python
import html

line = "    def example():"
result = html.escape(line).replace(" ", "&nbsp")

print(f"Result: {result}")
print(f"Expected: {html.escape(line).replace(' ', '&nbsp;')}")
print(f"\nInvalid entity: &nbsp (missing semicolon)")
print(f"Valid entity: &nbsp; (with semicolon)")
```

**Output:**
```
Result: &nbsp&nbsp&nbsp&nbspdef&nbspexample():
Expected: &nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;example():

Invalid entity: &nbsp (missing semicolon)
Valid entity: &nbsp; (with semicolon)
```

## Why This Is A Bug

Line 191 in `errors.py`:
```python
"line": html.escape(line).replace(" ", "&nbsp"),
```

According to the HTML specification (https://html.spec.whatwg.org/), named character references must end with a semicolon. The entity `&nbsp` (without semicolon) is not a valid HTML entity.

While modern browsers may be lenient and render `&nbsp` correctly in some contexts, it violates the HTML standard and may fail to render as a non-breaking space in certain situations, particularly when followed by specific characters.

This affects the debug error pages generated by Starlette, making the HTML technically invalid.

## Fix

```diff
--- a/starlette/middleware/errors.py
+++ b/starlette/middleware/errors.py
@@ -188,7 +188,7 @@ class ServerErrorMiddleware:
     def format_line(self, index: int, line: str, frame_lineno: int, frame_index: int) -> str:
         values = {
             # HTML escape - line could contain < or >
-            "line": html.escape(line).replace(" ", "&nbsp"),
+            "line": html.escape(line).replace(" ", "&nbsp;"),
             "lineno": (frame_lineno - frame_index) + index,
         }
```