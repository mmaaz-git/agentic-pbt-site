# Bug Report: dask.diagnostics.CacheProfiler Ignores Empty String metric_name Parameter

**Target**: `dask.diagnostics.CacheProfiler.__init__`
**Severity**: Low
**Bug Type**: Logic
**Date**: 2025-09-25

## Summary

The `CacheProfiler` constructor incorrectly ignores an explicitly provided empty string for the `metric_name` parameter due to a truthiness check, treating it identically to `None` and falling back to the metric function's name instead.

## Property-Based Test

```python
from hypothesis import given, strategies as st
from dask.diagnostics import CacheProfiler


def custom_metric(value):
    return len(str(value))


@given(st.text())
def test_cache_profiler_custom_metric_name(metric_name):
    prof = CacheProfiler(metric=custom_metric, metric_name=metric_name)
    assert prof._metric_name == metric_name


# Run the test
if __name__ == "__main__":
    test_cache_profiler_custom_metric_name()
```

<details>

<summary>
**Failing input**: `metric_name=''`
</summary>
```
Traceback (most recent call last):
  File "/home/npc/pbt/agentic-pbt/worker_/1/hypo.py", line 17, in <module>
    test_cache_profiler_custom_metric_name()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/npc/pbt/agentic-pbt/worker_/1/hypo.py", line 10, in test_cache_profiler_custom_metric_name
    def test_cache_profiler_custom_metric_name(metric_name):
                   ^^^
  File "/home/npc/miniconda/lib/python3.13/site-packages/hypothesis/core.py", line 2124, in wrapped_test
    raise the_error_hypothesis_found
  File "/home/npc/pbt/agentic-pbt/worker_/1/hypo.py", line 12, in test_cache_profiler_custom_metric_name
    assert prof._metric_name == metric_name
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError
Falsifying example: test_cache_profiler_custom_metric_name(
    metric_name='',
)
Explanation:
    These lines were always and only run by failing examples:
        /home/npc/miniconda/lib/python3.13/site-packages/dask/diagnostics/profile.py:355
Exit code: 1
```
</details>

## Reproducing the Bug

```python
from dask.diagnostics import CacheProfiler


def custom_metric(value):
    return len(str(value))


# Test with empty string metric_name
prof = CacheProfiler(metric=custom_metric, metric_name="")

print(f"Expected: metric_name = ''")
print(f"Actual:   metric_name = '{prof._metric_name}'")

# This assertion should pass if the bug is fixed
assert prof._metric_name == "", f"Expected empty string, got '{prof._metric_name}'"
```

<details>

<summary>
AssertionError: Expected empty string, got 'custom_metric'
</summary>
```
Expected: metric_name = ''
Actual:   metric_name = 'custom_metric'
Traceback (most recent call last):
  File "/home/npc/pbt/agentic-pbt/worker_/1/repo.py", line 15, in <module>
    assert prof._metric_name == "", f"Expected empty string, got '{prof._metric_name}'"
           ^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: Expected empty string, got 'custom_metric'
Exit code: 1
```
</details>

## Why This Is A Bug

This violates expected behavior because the code uses a truthiness check (`if metric_name:`) on line 353 of `dask/diagnostics/profile.py` instead of an explicit `None` check. This causes the following inconsistent behavior:

1. **Empty strings are treated as falsy and ignored**: When `metric_name=""` is explicitly provided, it evaluates to `False` in the truthiness check and falls through to use `metric.__name__` instead.

2. **Whitespace strings are preserved**: `metric_name="   "` evaluates to `True` and is correctly assigned to `self._metric_name`.

3. **Violates the principle of least surprise**: Users explicitly providing an empty string expect it to be used, not silently replaced with a default value. The distinction should be between "not provided" (`None`) and "provided as empty" (`""`).

4. **Inconsistent with test expectations**: The existing test suite shows that when `metric_name` is explicitly provided with a value like `"foo"` or `"non-standard"`, that exact value should be used (line 154 in test_profiler.py: `assert CacheProfiler(metric=nbytes, metric_name="foo")._metric_name == "foo"`).

5. **Undocumented behavior**: The `metric_name` parameter is not documented in the class docstring, and there's no indication that empty strings should be treated specially or ignored.

## Relevant Context

The `_metric_name` attribute is used for labeling in visualizations generated by the profiler. An empty metric name would result in labels like "Cache Size ()" which, while unusual, might be intentionally desired in certain visualization contexts where minimal labeling is preferred.

The current implementation at lines 353-358 in `/home/npc/pbt/agentic-pbt/envs/dask_env/lib/python3.13/site-packages/dask/diagnostics/profile.py`:
- Line 353: `if metric_name:` - Uses truthiness check
- Line 355: `elif metric:` - Falls back to metric function name
- Line 358: `else:` - Falls back to "count"

Testing shows the following behavior patterns:
- `metric_name=""` → `_metric_name='custom_metric'` (unexpected)
- `metric_name="   "` → `_metric_name='   '` (preserved)
- `metric_name="test"` → `_metric_name='test'` (preserved)
- `metric_name=None` → `_metric_name='custom_metric'` (expected fallback)

## Proposed Fix

```diff
--- a/dask/diagnostics/profile.py
+++ b/dask/diagnostics/profile.py
@@ -350,7 +350,7 @@ class CacheProfiler(Callback):
     def __init__(self, metric=None, metric_name=None):
         self.clear()
         self._metric = metric if metric else lambda value: 1
-        if metric_name:
+        if metric_name is not None:
             self._metric_name = metric_name
         elif metric:
             self._metric_name = metric.__name__
```