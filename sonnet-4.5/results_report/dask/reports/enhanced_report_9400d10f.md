# Bug Report: dask.diagnostics.ProgressBar Crashes with Negative dt Values

**Target**: `dask.diagnostics.ProgressBar`
**Severity**: Low
**Bug Type**: Crash
**Date**: 2025-09-25

## Summary

`ProgressBar` accepts negative `dt` (update interval) values in its constructor without validation, causing `ValueError` or `OverflowError` exceptions in the background timer thread when it attempts to sleep with a negative duration.

## Property-Based Test

```python
from hypothesis import given, strategies as st
from dask.diagnostics import ProgressBar
from dask.threaded import get
from operator import add
import io


@given(st.floats(max_value=-0.001, allow_nan=False, allow_infinity=False))
def test_progress_bar_negative_dt(dt):
    output = io.StringIO()
    dsk = {'x': 1, 'y': (add, 'x', 10)}

    with ProgressBar(dt=dt, out=output):
        result = get(dsk, 'y')

    assert result == 11


if __name__ == "__main__":
    test_progress_bar_negative_dt()
```

<details>

<summary>
**Failing input**: `dt=-0.1` (and various other negative values generated by Hypothesis)
</summary>
```
Exception in thread Thread-1 (_timer_func):
Traceback (most recent call last):
  File "/home/npc/miniconda/lib/python3.13/threading.py", line 1041, in _bootstrap_inner
    self.run()
    ~~~~~~~~^^
  File "/home/npc/miniconda/lib/python3.13/threading.py", line 992, in run
    self._target(*self._args, **self._kwargs)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/npc/miniconda/lib/python3.13/site-packages/dask/diagnostics/progress.py", line 129, in _timer_func
    time.sleep(self._dt)
    ~~~~~~~~~~^^^^^^^^^^
OverflowError: timestamp out of range for platform time_t
[Multiple similar exceptions for different threads, with both OverflowError and ValueError: sleep length must be non-negative]
```
</details>

## Reproducing the Bug

```python
from dask.diagnostics import ProgressBar
from dask.threaded import get
from operator import add
import io
import time

output = io.StringIO()
dsk = {'x': 1, 'y': (add, 'x', 10)}

pbar = ProgressBar(dt=-0.1, out=output)

with pbar:
    result = get(dsk, 'y')
    time.sleep(0.2)

print(f"Result: {result}")
print(f"Output: {output.getvalue()}")
```

<details>

<summary>
Exception in background thread with ValueError for negative sleep duration
</summary>
```
Exception in thread Thread-1 (_timer_func):
Traceback (most recent call last):
  File "/home/npc/miniconda/lib/python3.13/threading.py", line 1041, in _bootstrap_inner
    self.run()
    ~~~~~~~~^^
  File "/home/npc/miniconda/lib/python3.13/threading.py", line 992, in run
    self._target(*self._args, **self._kwargs)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/npc/miniconda/lib/python3.13/site-packages/dask/diagnostics/progress.py", line 129, in _timer_func
    time.sleep(self._dt)
    ~~~~~~~~~~^^^^^^^^^^
ValueError: sleep length must be non-negative
Result: 11
Output: [                                        ] | 0% Completed | 214.17 us[########################################] | 100% Completed | 1.97 ms
```
</details>

## Why This Is A Bug

This violates the principle of fail-fast design. The constructor accepts negative `dt` values without any validation, but the background timer thread's `_timer_func` method calls `time.sleep(self._dt)` at line 129, which raises exceptions for negative values:
- `ValueError: sleep length must be non-negative` for moderately negative values (e.g., -0.1)
- `OverflowError: timestamp out of range for platform time_t` for very large negative values (e.g., < -2147483)

The parameter `dt` is documented as "Update resolution in seconds" which semantically implies a non-negative duration. A negative time interval for update resolution doesn't make logical sense. Python's `time.sleep()` explicitly requires non-negative values as of Python 3.11 and will raise a `ValueError` for negative inputs.

The exceptions occur in a background thread, making them harder to debug and potentially polluting stderr without immediately crashing the main program. The computation still completes successfully, but with unhandled exceptions in the background.

## Relevant Context

The issue is located in `/dask/diagnostics/progress.py`:
- Line 82-90: The `__init__` method accepts the `dt` parameter and stores it directly as `self._dt` without any validation
- Line 99-101: A background timer thread is started with `_timer_func` as its target
- Line 129: The `_timer_func` method calls `time.sleep(self._dt)` in a loop, which fails for negative values

The documentation for the `dt` parameter states it's the "Update resolution in seconds, default is 0.1 seconds" but doesn't explicitly state that it must be non-negative. However, the semantic meaning clearly implies positive values.

Source code location: https://github.com/dask/dask/blob/main/dask/diagnostics/progress.py

## Proposed Fix

```diff
--- a/dask/diagnostics/progress.py
+++ b/dask/diagnostics/progress.py
@@ -86,6 +86,8 @@ class ProgressBar(Callback):
             # https://docs.python.org/3/library/sys.html#sys.__stderr__
             out = sys.stdout
         self._minimum = minimum
+        if dt < 0:
+            raise ValueError(f"dt must be non-negative, got {dt}")
         self._width = width
         self._dt = dt
         self._file = out
```