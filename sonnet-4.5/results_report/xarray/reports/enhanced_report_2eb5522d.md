# Bug Report: xarray.core.formatting_html._load_static_files Cache Mutation Vulnerability

**Target**: `xarray.core.formatting_html._load_static_files`
**Severity**: Medium
**Bug Type**: Logic
**Date**: 2025-09-25

## Summary

The `_load_static_files()` function uses `@lru_cache` decorator but returns a mutable list, allowing callers to corrupt the cached data. This violates the immutability contract expected from cached functions.

## Property-Based Test

```python
import sys
sys.path.insert(0, '/home/npc/pbt/agentic-pbt/envs/xarray_env/lib/python3.13/site-packages')

from hypothesis import given, strategies as st
from xarray.core.formatting_html import _load_static_files


@given(st.text())
def test_cache_immutability(mutation_data):
    result1 = _load_static_files()
    original_length = len(result1)

    result1.append(mutation_data)

    result2 = _load_static_files()

    assert len(result2) == original_length, \
        "Cached result should not be affected by mutations to previous return values"

if __name__ == "__main__":
    test_cache_immutability()
```

<details>

<summary>
**Failing input**: `''` (empty string)
</summary>
```
Traceback (most recent call last):
  File "/home/npc/pbt/agentic-pbt/worker_/51/hypo.py", line 21, in <module>
    test_cache_immutability()
    ~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/npc/pbt/agentic-pbt/worker_/51/hypo.py", line 9, in test_cache_immutability
    def test_cache_immutability(mutation_data):
                   ^^^
  File "/home/npc/pbt/agentic-pbt/envs/xarray_env/lib/python3.13/site-packages/hypothesis/core.py", line 2124, in wrapped_test
    raise the_error_hypothesis_found
  File "/home/npc/pbt/agentic-pbt/worker_/51/hypo.py", line 17, in test_cache_immutability
    assert len(result2) == original_length, \
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: Cached result should not be affected by mutations to previous return values
Falsifying example: test_cache_immutability(
    mutation_data='',
)
```
</details>

## Reproducing the Bug

```python
import sys
sys.path.insert(0, '/home/npc/pbt/agentic-pbt/envs/xarray_env/lib/python3.13/site-packages')

from xarray.core.formatting_html import _load_static_files

# Get initial cached result
result1 = _load_static_files()
print(f"Initial length: {len(result1)}")
print(f"Type of result: {type(result1)}")

# Mutate the cached list
result1.append("CORRUPTED DATA")
print(f"Length after appending to result1: {len(result1)}")

# Get the supposedly cached result again
result2 = _load_static_files()
print(f"Length of result2 (should be same as initial): {len(result2)}")
print(f"Last element of result2: {result2[-1]}")

# Check if the cache was corrupted
if len(result2) != 2:
    print("\nERROR: Cache was mutated! The cached list is not protected from modifications.")
    print(f"Expected length: 2, Got: {len(result2)}")
else:
    print("\nCache is properly protected.")
```

<details>

<summary>
ERROR: Cache corruption detected - cached list modified by external code
</summary>
```
Initial length: 2
Type of result: <class 'list'>
Length after appending to result1: 3
Length of result2 (should be same as initial): 3
Last element of result2: CORRUPTED DATA

ERROR: Cache was mutated! The cached list is not protected from modifications.
Expected length: 2, Got: 3
```
</details>

## Why This Is A Bug

The `@lru_cache` decorator from Python's `functools` module is designed to memoize function results for performance optimization. According to Python's documentation, cached functions should be pure - returning the same result for the same input without side effects.

When a cached function returns a mutable object like a list, this creates a shared reference problem. All callers receive the same list object from the cache, not a copy. Any modification to this list by one caller affects all subsequent callers, violating the principle that cached functions should behave identically whether the result comes from cache or fresh computation.

In xarray, `_load_static_files()` loads CSS and HTML resources that are meant to be immutable static content. The function correctly uses caching to avoid repeatedly reading these files from disk. However, returning a mutable list undermines this design - any code that receives the list can accidentally or maliciously modify it, corrupting the cached data for all future HTML representations generated by xarray objects.

## Relevant Context

The `_load_static_files()` function is called by `_obj_repr()` at line 305 of `/home/npc/pbt/agentic-pbt/envs/xarray_env/lib/python3.13/site-packages/xarray/core/formatting_html.py`. This function is responsible for loading static CSS and HTML resources used for rendering xarray objects in Jupyter notebooks and other HTML contexts.

The function reads from two static files defined in the `STATIC_FILES` tuple:
- `xarray.static.html/icons-svg-inline.html`
- `xarray.static.css/style.css`

These files contain the visual styling and icons for xarray's HTML representations. Since these are static resources that never change during program execution, caching them is appropriate. The bug doesn't affect normal xarray usage unless code accidentally modifies the returned list.

Documentation on `lru_cache`: https://docs.python.org/3/library/functools.html#functools.lru_cache
Source code location: xarray/core/formatting_html.py:29-35

## Proposed Fix

```diff
--- a/xarray/core/formatting_html.py
+++ b/xarray/core/formatting_html.py
@@ -29,7 +29,7 @@ if TYPE_CHECKING:
 @lru_cache(None)
 def _load_static_files():
     """Lazily load the resource files into memory the first time they are needed"""
-    return [
+    return tuple(
         files(package).joinpath(resource).read_text(encoding="utf-8")
         for package, resource in STATIC_FILES
-    ]
+    )
```