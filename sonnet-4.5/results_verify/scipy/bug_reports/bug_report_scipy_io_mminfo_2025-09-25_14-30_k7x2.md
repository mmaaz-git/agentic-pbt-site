# Bug Report: scipy.io.mminfo Crash on Repeated Calls

**Target**: `scipy.io.mminfo`
**Severity**: High
**Bug Type**: Crash
**Date**: 2025-09-25

## Summary

Calling `scipy.io.mminfo()` multiple times in a loop causes a fatal Python crash (segfault) when used with matrices generated by `np.random.rand()`.

## Property-Based Test

```python
import tempfile
import numpy as np
from scipy import io as scipy_io
from hypothesis import given, strategies as st, settings


@st.composite
def dense_real_arrays(draw):
    rows = draw(st.integers(min_value=1, max_value=20))
    cols = draw(st.integers(min_value=1, max_value=20))
    data = draw(
        st.lists(
            st.floats(
                min_value=-1e10,
                max_value=1e10,
                allow_nan=False,
                allow_infinity=False,
            ),
            min_size=rows * cols,
            max_size=rows * cols,
        )
    )
    return np.array(data).reshape(rows, cols)


@given(dense_real_arrays())
@settings(max_examples=100)
def test_mminfo_consistency_with_mmread_dense(original):
    with tempfile.NamedTemporaryFile(mode='w+b', suffix='.mtx', delete=False) as f:
        scipy_io.mmwrite(f, original)
        f.flush()
        f.seek(0)

        info_result = scipy_io.mminfo(f)
        rows, cols, entries, format_type, field = info_result[:5]

        f.seek(0)
        result = scipy_io.mmread(f, spmatrix=False)

    assert rows == original.shape[0]
    assert cols == original.shape[1]
```

**Failing input**: Any array generated by the hypothesis strategy or `np.random.rand()`. The crash occurs on the second iteration of the test.

## Reproducing the Bug

```python
import tempfile
import numpy as np
from scipy import io as scipy_io

for i in range(5):
    arr = np.random.rand(i+1, i+1)

    with tempfile.NamedTemporaryFile(mode='w+b', suffix='.mtx') as f:
        scipy_io.mmwrite(f, arr)
        f.flush()
        f.seek(0)
        scipy_io.mminfo(f)
```

Running this script with pytest causes:
```
Fatal Python error: Aborted

Current thread 0x0000705517d92600 (most recent call first):
  File "/home/npc/.local/lib/python3.13/site-packages/scipy/io/_fast_matrix_market/__init__.py", line 597 in mminfo
```

## Why This Is A Bug

The `mminfo()` function should not crash when called multiple times, regardless of the input matrices. A fatal Python error indicates a segfault or assertion failure in the underlying C/C++ implementation, suggesting a memory management issue (e.g., use-after-free, double-free, or buffer overflow).

The bug appears to be specific to:
1. Calling `mminfo()` multiple times within the same process
2. Using floating-point arrays (particularly those generated by `np.random.rand()`)

This is a critical bug because:
- It causes a complete process crash rather than raising a Python exception
- It affects normal use cases where users might want to inspect multiple Matrix Market files
- It's triggered by property-based testing, which is a standard practice for robust code validation

## Fix

The crash occurs in the C++ implementation of `mminfo` at line 597 of `scipy/io/_fast_matrix_market/__init__.py`. This suggests an issue with state management or resource cleanup in the underlying fast_matrix_market library.

Potential causes:
1. Static/global state that's not properly reset between calls
2. Memory corruption in the C++ implementation
3. Threading issues if the library uses thread-local storage

A proper fix would require investigating the C++ code at the crash location to identify the memory management error. Common fixes might include:
- Properly initializing/resetting static state between function calls
- Fixing buffer management to prevent overflows
- Adding proper resource cleanup (RAII patterns)
- Ensuring thread-safety if applicable

Without access to the C++ source code, the specific fix cannot be determined, but the crash location at line 597 should be the starting point for investigation.